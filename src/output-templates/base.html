<html>
<header>
	<style>
        *{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

		html {
			margin: 10%;
            margin-top: 20px;
            overflow: -moz-scrollbars-vertical; 
            overflow-y: scroll;
		}
		#instruction {
			border: 2px solid black;
			border-radius: 5px;
			min-height: 10px;
            background-color: #faf3ee;
            padding: 5px 15px 5px 10px;
		}
 
		h5 {
			font-weight: normal;
            margin: 0px 0px 5px 0px;
            font-size: 16px;
		}

		h3{
            margin-bottom: 5px;
            margin-top: 30px;
        }

        .ingredientsHeader, .collapsible:first-of-type{
            margin: 10px 0 5px 0;
        }

		.collapsible {
            padding-left: 10px;
            float: left;
		}
        .wrapper {
            overflow: hidden; /* add this to contain floated children */
            position: relative;
        }
        .time-header {
            margin-left: 10px;
            margin-right: 5px;
            font-weight: bold;
            float:left; 
        }
        .time-content {
            float: left; 
            margin-right: 20px;
        }
        #titleDiv{
            float:left; 
            margin-bottom: 10px;
            margin-left: 10px;
        }
        #servingsDiv{
            float: right;
            margin-right: 10px;
        }
        .leftHalf{
            float: left;
            margin-right: 5%;
            width: calc(15% - 10px);
            margin-left: 10px;
        }
        .rightHalf{
            float: left;
            width: calc(80% - 10px);
            margin-right: 10px;
        }
        .arrow-down {
            width: 0; 
            height: 0; 
            float: left;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #d7d7d7;
            margin-bottom: -8px;
        }
        .radioButton:hover{
            background: #ececec;
            border-radius: 5px;
            cursor: pointer;
        }
        .collapsible-wrapper:hover>.arrow-down{
            border-top-color: #898989;
        }
        .collapsible-wrapper{
            align-items: center;
            display: flex;
            cursor: pointer;
            user-select: none;
        }
        .collapsible-body{
            margin-bottom: 25px;
        }
        #description{
            padding-left: 10px;
            float: left;
        }
        .collapseAllButton{
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
        .resetAmount{
            width: 50px;
        }
        .servings{
            width: 50px;
        }
        .instructionBody{
            margin-top: 0px;
            margin-bottom: 0px;
        }
        .body-rule{
            border: none;
            height: 2px;
            background: black;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .arrow{
            font-size: 22px;
            line-height: 14px;
        }
        .measurementSystem{
            float: right;
            margin-right: 15px;
        }
	</style>
</header>
<div class="wrapper">
    <h1 id="titleDiv">
        ~title~
    </h1>
    <button class = collapseAllButton onclick="collapseOrExpand()" > Collapse All </button>
</div>
<hr>
<div class="wrapper">
    ~total-time~
    ~prep-time~
    ~cook-time~
    <div id="servingsDiv">
        <button class = resetAmount disabled="false" onclick="resetAmount()" > Reset </button>
        ~servings~
    </div>
    <select class="measurementSystem">
        <option hidden value="convertUnits">Convert Units</option>
        <option value="original">Original</option>
        <option value="metric">Metric</option>
        <option value="imperial">Imperial</option>
    </select>
</div>
<hr>
<div class="wrapper">
    <div class="leftHalf">
        ~ingredients~
		~optionalIngredients~
        ~kitchenware~
        ~nutrients~
        ~tags~
    </div>
    <div class="rightHalf">
        <div class="collapsible-wrapper">
            <div class="arrow-down"></div>
            <h3 class="collapsible">
                Description
            </h3>
        </div>
        <div class="collapsible-body">
            ~description~
        </div>
    
        <!-- steps -->
        ~instructions~
    
        <script>
            /* arrays of HTML elements */
            const headers = document.getElementsByClassName("collapsible-wrapper");
            const steps = document.getElementsByClassName("collapsible-body");
            const arrows = document.getElementsByClassName("arrow-down");
            const numbers = document.getElementsByClassName("number");
            const units = document.getElementsByClassName("unit");

            /* single HTML elements */
            const collapseAllButton = document.getElementsByClassName("collapseAllButton")[0];
            const resetAmountButton = document.getElementsByClassName("resetAmount")[0];
            const servingsField = document.getElementsByClassName("servings")[0];
            const measurementSystemDropDown = document.getElementsByClassName("measurementSystem")[0];

            /* amount arrays */
            let currentAmounts = [];
            let defaultAmounts = [];
            let metricAmounts = [];
            let imperialAmounts = [];

            /* miscellaneous variables */
            let allAreCollapsed = false;
            let defaultNumberOfServings = servingsField.value;
            let measurementSystem = "original";

            metricUnits = [
                "g",
                "kg",
                "ml",
                "dl",
                "l",
                "mm",
                "cm",
                "c"
            ];

            invalidChars = [
                "-",
                "+",
                "e",
                ","
            ];
            
            /* object constructor for amounts */
            function Amount(number, unit) {
                this.number = number;
                this.unit = unit;
            }

            /* constants and functions for converting between metric and imperial */
            const G_TO_OZ = 0.035;
            const KG_TO_LBS = 2.2046;
            const L_TO_QT = 1.057;
            const ML_TO_FLOZ = 0.0338;
            const DL_TO_FLOZ = 3.38;
            const M_TO_FEET = 3.28;
            const CM_TO_INCH = 0.39370079;
            const MM_TO_INCH = 0.039;

            function C_TO_F(deg)
            {
                return deg * 9 / 5 + 32;
            }
            function F_TO_C(deg)
            {
                return (deg - 32) * 5 / 9;
            }

            /* initialize and assign final values to the arrays for holding amounts */
            saveStartValues();
            function saveStartValues(){
                for (i = 0; i < numbers.length; i++) {
                    let defaultNumber = parseFloat(numbers[i].innerHTML) / defaultNumberOfServings;
                    let defaultUnit = units[i].innerHTML;
                    var defaultAmount = new Amount(defaultNumber, defaultUnit);

                    defaultAmounts.push(defaultAmount);
                    metricAmounts.push(defaultAmount);
                    imperialAmounts.push(defaultAmount);

                    if(isMetric(defaultUnit)){ /* convert to imperial */ 
                        metricAmounts[i] = defaultAmount;
                        imperialAmounts[i] = getMetricToImperial(defaultAmount);
                    }
                    else { /* convert to metric */ 
                        metricAmounts[i] = getImperialToMetric(defaultAmount);
                        imperialAmounts[i] = defaultAmount;
                    }
                }
            }

            /* listen for changes on the dropdown menu */
            measurementSystemDropDown.addEventListener("change", () => {
                measurementSystem = measurementSystemDropDown.value;
                updateNumbers();
            });

            /* listen for clicks on the dropdown arrows */
            for (i = 0; i < headers.length; i++) {
                const header = headers[i];
                const step = steps[i];
                const arrow = arrows[i];

                header.addEventListener("click", (ev) => {
                    if(step.style.display == "none"){
                        step.style.display = "block";
                        arrow.style.transform = "rotate(0deg)";
                    }
                    else {
                        step.style.display = "none";
                        arrow.style.transform = "rotate(-90deg)";
                    }
                    checkCollapseStatus();
                });
            }


            /* expand all segments if all are collapsed, else collapse all */
            function collapseOrExpand(){
                if (allAreCollapsed){
                    collapseAll(false); /* expand */ 
                }
                else {
                    collapseAll(true);  /* collapse */ 
                }
                checkCollapseStatus();
            }

            /* show/hide segments and rotate arrows */
            function collapseAll(collapse){
                allAreCollapsed = collapse;
                let display = "block";
                let rotation = "rotate(0deg)";
                if (collapse){
                    display = "none";
                    rotation = "rotate(-90deg)";
                }
                
                for (i = 0; i < headers.length; i++) {
                    const step = steps[i];
                    const arrow = arrows[i];
                    step.style.display = display;
                    arrow.style.transform = rotation;
                }
            }

            /* change collapse/expand button depending on whether all segments are collapsed/expanded */
            function checkCollapseStatus(){
                oneIsNotCollapsed = false;
                for (j = 0; j < headers.length; j++) {
                    if (steps[j].style.display == "block"){
                        oneIsNotCollapsed = true;
                    }
                }

                if(oneIsNotCollapsed){
                    allAreCollapsed = false;
                }
                else {
                    allAreCollapsed = true;
                }

                if(allAreCollapsed){
                    collapseAllButton.innerHTML = "Expand All";
                }
                else {
                    collapseAllButton.innerHTML = "Collapse All";
                }
            }

            /* limit the range of numbers which can be written in the "servings" field */
            function truncate(){
                value = parseInt(servingsField.value);
                max = parseInt(servingsField.max);
                min = parseInt(servingsField.min);
                if(value > max){
                    servingsField.value = servingsField.max;
                }
                else if(value < min){
                    servingsField.value = servingsField.min;
                }
            }

            /* prohibit writing illegal characters in the "servings" field */
            servingsField.addEventListener("keydown", e => {
                if (invalidChars.includes(e.key)) {
                    e.preventDefault();
                }
            });
            
            /* change amounts according to which measurement system is chosen */
            function updateNumbers(){
                truncate();
                changeMeasurementSystem();

                /* if no number is written in the servings field, don't do anything*/
                if (servingsField.value != ""){ 
                    for (i = 0; i < numbers.length; i++) {
                        let newNumber = (currentAmounts[i].number * parseFloat(servingsField.value));
                        newNumber = Math.round((newNumber + Number.EPSILON)* 100.0) / 100.0;
                        numbers[i].innerHTML = newNumber.toString();
                        units[i].innerHTML = currentAmounts[i].unit;  
                    }
                }

                /* disable reset button if the number of servings is already the default number */
                if (servingsField.value == defaultNumberOfServings){
                    resetAmountButton.disabled = true;
                }
                else {
                    resetAmountButton.disabled = false;
                }
            }

            /* reset servings amount to default */
            function resetAmount(){
                servingsField.value = defaultNumberOfServings.toString();
                updateNumbers(servingsField);
            }

            /* check if a unit is in the metric system */
            function isMetric(unit){
                if(metricUnits.includes(unit)){
                    return true;
                }
                else return false;
            }

            /* convert metric amounts to imperial amounts */
            function getMetricToImperial(metricAmount){
                var imperialAmount = Object.assign({}, metricAmount); /* copy object */

                switch(metricAmount.unit){
                    case "g":     convertToImperial(imperialAmount, G_TO_OZ, "oz");                     break;
                    case "kg":    convertToImperial(imperialAmount, KG_TO_LBS, "lbs");                  break;
                    case "ml":    convertToImperial(imperialAmount, ML_TO_FLOZ, "fl-oz");               break;
                    case "dl":    convertToImperial(imperialAmount, DL_TO_FLOZ, "fl-oz");               break;
                    case "l":     convertToImperial(imperialAmount, L_TO_QT, "qt");                     break;
                    case "mm":    convertToImperial(imperialAmount, MM_TO_INCH, "in");                  break;
                    case "cm":    convertToImperial(imperialAmount, CM_TO_INCH, "in");                  break;
                    case "c":     imperialAmount.number *= C_TO_F(number);   imperialAmount.unit = "f"; break;
                    default:      /* unit is not in the metric system */
                }
                return imperialAmount;
            }

            /* convert imperial amounts to metric amounts */
            function getImperialToMetric(imperialAmount){
                var metricAmount = Object.assign({}, imperialAmount); /* copy object */
                switch(imperialAmount.unit){
                    case "oz":      convertToMetric(metricAmount, G_TO_OZ, "g");                   break;
                    case "lbs":     convertToMetric(metricAmount, KG_TO_LBS, "kg");                break;
                    case "fl-oz":   convertToMetric(metricAmount, ML_TO_FLOZ, "ml");               break;
                    case "qt":      convertToMetric(metricAmount, L_TO_QT, "l");                   break;
                    case "in":      convertToMetric(metricAmount, CM_TO_INCH, "cm");               break;
                    case "ft":      convertToMetric(metricAmount, M_TO_FEET, "m");                 break;
                    case "f":       metricAmount.number = F_TO_C(number);    metricAmount.unit = "c";   break;
                    default:        /* unit is not in the imperial system */
                }
                return metricAmount;
            }

            /* update imperial amount with correct number and unit */
            function convertToImperial(imperialAmount, conversionRate, newUnit){
                imperialAmount.number *= conversionRate;
                imperialAmount.unit = newUnit;
            }

            /* update metric amount with correct number and unit */
            function convertToMetric(metricAmount, conversionRate, newUnit){
                metricAmount.number /= conversionRate;
                metricAmount.unit = newUnit;
            }

            /* change current amount to fit the selected measurement system */
            function changeMeasurementSystem(){
                if (measurementSystem == "imperial"){
                    for (i = 0; i < numbers.length; i++) {
                        currentAmounts[i] = imperialAmounts[i];
                    }
                }
                else if (measurementSystem == "metric"){
                    for (i = 0; i < numbers.length; i++) {
                        currentAmounts[i] = metricAmounts[i];
                    }
                }
                else { /* default amounts */
                    for (i = 0; i < numbers.length; i++) {
                        currentAmounts[i] = defaultAmounts[i];    
                    }
                }
            }
        </script>
    </div>
</div>

</html>