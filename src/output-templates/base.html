<html>
<header>
	<style>
        *{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

		html {
			margin: 10%;
            margin-top: 20px;
            overflow: -moz-scrollbars-vertical; 
            overflow-y: scroll;
		}
		#instruction {
			border: 2px solid black;
			border-radius: 5px;
			min-height: 10px;
            background-color: #faf3ee;
            padding: 5px 15px 5px 10px;
		}
 
		h5 {
			font-weight: normal;
            margin: 0px 0px 5px 0px;
            font-size: 16px;
		}

		h3{
            margin-bottom: 5px;
            margin-top: 30px;
        }
        h3:first-of-type{
            margin: 10px 0 5px 0;   
        }
		h4{
            margin: 5px 0 5px 0;
        }

        .topField, .collapsible:first-of-type{
            margin: 10px 0 5px 0;
        }

		a {
			font-style: normal
		}

		.colltext {
			display: block;
			color: darkslategray;  
			margin: 5px 10px;
			font-style: italic;
			cursor: context-menu;
		}

		.collapsible {
            padding-left: 10px;
            float: left;
		}
        .wrapper {
            overflow: hidden; /* add this to contain floated children */
            position: relative;
        }
        .time-header {
            margin-left: 10px;
            margin-right: 5px;
            font-weight: bold;
            float:left; 
        }
        .time-content {
            float: left; 
            margin-right: 20px;
        }
        #titleDiv{
            float:left; 
            margin-bottom: 10px;
            margin-left: 10px;
        }
        #servingsDiv{
            float: right;
            margin-right: 10px;
        }
        .leftHalf{
            float: left;
            margin-right: 5%;
            width: calc(15% - 10px);
            margin-left: 10px;
        }
        .rightHalf{
            float: left;
            width: calc(80% - 10px);
            margin-right: 10px;
        }
        .arrow-down {
            width: 0; 
            height: 0; 
            float: left;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #d7d7d7;
            margin-bottom: -8px;
        }
        .radioButton:hover{
            background: #ececec;
            border-radius: 5px;
            cursor: pointer;
        }
        .collapsible-wrapper:hover>.arrow-down{
            border-top-color: #898989;
        }
        .collapsible-wrapper{
            align-items: center;
            display: flex;
            cursor: pointer;
            user-select: none;
        }
        .collapsible-body{
            margin-bottom: 25px;
        }
        #description{
            padding-left: 10px;
            float: left;
        }
        .collapseAllButton{
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
        .resetAmount{
            width: 50px;
        }
        .servings{
            width: 50px;
        }
        .instructionBody{
            margin-top: 0px;
            margin-bottom: 0px;
        }
        .body-rule{
            border: none;
            height: 2px;
            background: black;
        }
        .arrow{
            font-size: 22px;
            line-height: 14px;
        }
        .measurementSystem{
            float: right;
            margin-right: 15px;
        }
	</style>
</header>
<div class="wrapper">
    <h1 id="titleDiv">
        ~title~
    </h1>
    <button class = collapseAllButton onclick="collapseOrExpand()" > Collapse All </button>
</div>
<hr>
<div class="wrapper">
    ~total-time~
    ~prep-time~
    ~cook-time~
    <div id="servingsDiv">
        <button class = resetAmount disabled="false" onclick="resetAmount()" > Reset </button>
        ~servings~
    </div>
    <select class="measurementSystem">
        <option hidden value="convertUnits">Convert Units</option>
        <option value="original">Original</option>
        <option value="metric">Metric</option>
        <option value="imperial">Imperial</option>
    </select>
</div>
<hr>
<div class="wrapper">
    <div class="leftHalf">
        <!--
        <div>
            <h3 class="topField">
                <strong>Convert Units</strong>
            </h3>
            <form class="">
                <label class="radioButton"><input type="radio" id="java" id="original" name="measurementSystem" value="original" onclick="convertUnits(value)" checked> Original &nbsp </label><br>
                <label class="radioButton"><input type="radio" id="metric" name="measurementSystem" value="metric" onclick="convertUnits(value)"> Metric &nbsp </label><br>
                <label class="radioButton"><input type="radio" id="imperial" name="measurementSystem" value="imperial" onclick="convertUnits(value)"> Imperial &nbsp </label>
            </form>
        </div>  
        -->
        ~ingredients~
		~optionalIngredients~
        ~kitchenware~
        ~nutrients~
        ~tags~
    </div>
    <div class="rightHalf">
        <div class="collapsible-wrapper">
            <div class="arrow-down"></div>
            <h3 class="collapsible">
                Description
            </h3>
        </div>
        <div class="collapsible-body">
            ~description~
        </div>
    
        <!-- steps -->
        ~instructions~
    
        <script>
            const headers = document.getElementsByClassName("collapsible-wrapper");
            const steps = document.getElementsByClassName("collapsible-body");
            const arrows = document.getElementsByClassName("arrow-down");
            const numbers = document.getElementsByClassName("number");
            const units = document.getElementsByClassName("unit");

            const collapseAllButton = document.getElementsByClassName("collapseAllButton")[0];
            const resetAmountButton = document.getElementsByClassName("resetAmount")[0];
            const servingsField = document.getElementsByClassName("servings")[0];

            let collapsed = false;
            let defaultAmount = servingsField.value;
            let measurementSystem = "original";
            let currentNumbers = [];
            let defaultNumbers = [];
            let metricNumbers = [];
            let imperialNumbers = [];
            let defaultUnits = [];
            let metricUnits = [];
            let imperialUnits = [];
            
            const measurementSystemDropDown = document.getElementsByClassName("measurementSystem")[0];
            measurementSystemDropDown.addEventListener("change", convertUnits);

            /* Dublicate code, can we include it from the h_file? */
            const G_TO_OZ = 0.035;
            const KG_TO_LBS = 2.2046;
            const L_TO_QT = 1.057;
            const ML_TO_FLOZ = 0.0338;
            const DL_TO_FLOZ = 3.38;
            const M_TO_FEET = 3.28;
            const CM_TO_INCH = 0.39370079;
            const MM_TO_INCH = 0.039;

            function C_TO_F(deg)
            {
                return deg * 9 / 5 + 32;
            }
            function F_TO_C(deg)
            {
                return (deg - 32) * 5 / 9;
            }

            for (i = 0; i < headers.length; i++) {
                const header = headers[i];
                const step = steps[i];
                const arrow = arrows[i];

                header.addEventListener("click", (ev) => {
                    if(step.style.display == "none"){
                        step.style.display = "block";
                        arrow.style.transform = "rotate(0deg)";
                    }
                    else {
                        step.style.display = "none";
                        arrow.style.transform = "rotate(-90deg)";
                    }
                        
                    checkCollapseStatus();
                });
                
                // check if all headers are collapsed
            }

        function collapseOrExpand(){
            if (collapsed){
                expandAll();
            }
            else {
                collapseAll();
            }
            checkCollapseStatus();
        }

        function checkCollapseStatus(){
            oneIsNotCollapsed = false;
            for (j = 0; j < headers.length; j++) {
                if (steps[j].style.display == "block"){
                    oneIsNotCollapsed = true;
                }
            }

            if(oneIsNotCollapsed){
                collapsed = false;
            }
            else {
                collapsed = true;
            }

            if(collapsed){
                collapseAllButton.innerHTML = "Expand All";
            }
            else {
                collapseAllButton.innerHTML = "Collapse All";
            }
        }

        function collapseAll(){
            collapsed = true;

            for (i = 0; i < headers.length; i++) {
                const header = headers[i];
                const step = steps[i];
                const arrow = arrows[i];

                step.style.display = "none";
                arrow.style.transform = "rotate(-90deg)";
            }
        }

        function expandAll(){
            collapsed = false;
            
            for (i = 0; i < headers.length; i++) {
                const header = headers[i];
                const step = steps[i];
                const arrow = arrows[i];

                step.style.display = "block";
                arrow.style.transform = "rotate(0deg)";
            }
        }

        function truncate(){
            value = parseInt(servingsField.value);
            max = parseInt(servingsField.max);
            min = parseInt(servingsField.min);
            if(value > max){
                servingsField.value = servingsField.max;
            }
            else if(value < min){
                servingsField.value = servingsField.min;
            }
        }

        invalidChars = [
            "-",
            "+",
            "e",
            ","
        ];

        servingsField.addEventListener("keydown", e => {
        if (invalidChars.includes(e.key)) {
            e.preventDefault();
        }
        })

        function updateNumbers(){
            truncate();
            if (measurementSystem == "imperial"){
                for (i = 0; i < numbers.length; i++) {
                    currentNumbers[i] = imperialNumbers[i];
                    units[i].innerHTML = imperialUnits[i];
                }
            }
            else if (measurementSystem == "metric"){
                for (i = 0; i < numbers.length; i++) {
                    currentNumbers[i] = metricNumbers[i];
                    units[i].innerHTML = metricUnits[i];
                }
                
            }
            else {
                for (i = 0; i < numbers.length; i++) {
                    currentNumbers[i] = defaultNumbers[i];      
                    units[i].innerHTML = defaultUnits[i];      
                }
            }


            if (servingsField.value != ""){
                for (i = 0; i < numbers.length; i++) {
                    let newNumber = (currentNumbers[i] * parseFloat(servingsField.value));
                    newNumber = Math.round((newNumber + Number.EPSILON)* 100.0) / 100.0;
                    numbers[i].innerHTML = newNumber.toString();
                }
            }

            if (servingsField.value == defaultAmount){
                resetAmountButton.disabled = true;
            }
            else {
                resetAmountButton.disabled = false;
            }
        }

        function saveStartValues(){
            for (i = 0; i < numbers.length; i++) {
                let number = parseFloat(numbers[i].innerHTML);
                let defaultNumber = number / defaultAmount;
                defaultNumbers.push(defaultNumber);
                metricNumbers.push(defaultNumber);
                imperialNumbers.push(defaultNumber);
                defaultUnits.push(units[i].innerHTML);
                metricUnits.push(units[i].innerHTML);
                imperialUnits.push(units[i].innerHTML);
                let unit = units[i].innerHTML;

                if(isMetric(unit)){
                    var [imperialNumber, imperialUnit] = getMetricToImperial(number, unit); 
                    metricNumbers[i] = (number / defaultAmount);
                    imperialNumbers[i] = (imperialNumber / defaultAmount);
                    imperialUnits[i] = imperialUnit;
                }
                else{
                    var [metricNumber, metricUnit] = getImperialToMetric(number, unit); 
                    metricNumbers[i] = metricNumber / defaultAmount;
                    imperialNumbers[i] = (number / defaultAmount);
                    metricUnits[i] = metricUnit;
                }
            }
        }
        saveStartValues();

        function resetAmount(){
            servingsField.value = defaultAmount.toString();
            updateNumbers(servingsField);
        }

        function isMetric(unit){
            switch(unit){
                case "g":     
                case "kg":    
                case "ml":    
                case "dl":    
                case "l":     
                case "mm":    
                case "cm":    
                case "c":   return true;
            }
            return false;
        }

        // Should we not scale cups, gals and kcal?

        function getMetricToImperial(number, unit){
            let scaledNumber = number;
            let newUnit = unit;
            switch(unit){
                case "g":     scaledNumber *= G_TO_OZ;          newUnit = "oz";     break;
                case "kg":    scaledNumber *= KG_TO_LBS;        newUnit = "lbs";    break;
                case "ml":    scaledNumber *= ML_TO_FLOZ;       newUnit = "fl-oz";  break;
                case "dl":    scaledNumber *= DL_TO_FLOZ;       newUnit = "fl-oz";  break;
                case "l":     scaledNumber *= L_TO_QT;          newUnit = "qt";     break;
                case "mm":    scaledNumber *= MM_TO_INCH;       newUnit = "in";     break;
                case "cm":    scaledNumber *= CM_TO_INCH;       newUnit = "in";     break;
                case "c":     scaledNumber *= C_TO_F(number);   newUnit = "f";      break;
            }
            return [scaledNumber, newUnit];
        }

        function getImperialToMetric(number, unit){
            let scaledNumber = number;
            let newUnit = unit;
            switch(unit){
                case "oz":      scaledNumber /= G_TO_OZ;          newUnit = "g";    break;
                case "lbs":     scaledNumber /= KG_TO_LBS;        newUnit = "kg";   break;
                case "fl-oz":   scaledNumber /= ML_TO_FLOZ;       newUnit = "ml";   break;
                case "qt":      scaledNumber /= L_TO_QT;          newUnit = "l";    break;
                case "in":      scaledNumber /= CM_TO_INCH;       newUnit = "cm";   break;
                case "ft":      scaledNumber /= M_TO_FEET;        newUnit = "m";    break;
                case "f":       scaledNumber = F_TO_C(number);    newUnit = "c";    break;
            }
            return [scaledNumber, newUnit];
        }

        function convertUnits(){
            console.log(measurementSystemDropDown.value);
            measurementSystem = measurementSystemDropDown.value;
            updateNumbers();
        }

        </script>
    </div>
</div>

</html>